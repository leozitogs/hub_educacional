# ============================================================================
# Hub Inteligente de Recursos Educacionais - Pipeline de CI (GitHub Actions)
# ============================================================================
# Autor: Leonardo GonÃ§alves Sobral - 19 anos
#        CiÃªncia da ComputaÃ§Ã£o - 3Â° PerÃ­odo
# ============================================================================
#
# Esta pipeline de IntegraÃ§Ã£o ContÃ­nua (CI) Ã© executada automaticamente
# a cada push e pull request, garantindo a qualidade do cÃ³digo atravÃ©s de:
#
#   1. Linting com flake8: Verifica conformidade com PEP 8 e detecta
#      erros comuns (variÃ¡veis nÃ£o utilizadas, imports incorretos, etc.).
#
#   2. FormataÃ§Ã£o com black: Verifica se o cÃ³digo segue o estilo de
#      formataÃ§Ã£o do Black (determinÃ­stico e consistente).
#
#   3. Testes com pytest: Executa a suÃ­te de testes unitÃ¡rios para
#      garantir que nenhuma regressÃ£o foi introduzida.
#
# A pipeline utiliza uma matrix strategy para testar em mÃºltiplas
# versÃµes do Python, garantindo compatibilidade.
# ============================================================================

name: CI - Linting & Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # â”€â”€ Job de Linting e FormataÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: "ğŸ” Lint & Format Check"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: "ğŸ“¥ Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "ğŸ Configurar Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "backend/requirements.txt"

      - name: "ğŸ“¦ Instalar dependÃªncias"
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black

      - name: "ğŸ” Verificar estilo com flake8"
        run: |
          # Executa o flake8 com configuraÃ§Ãµes customizadas:
          # --max-line-length=120: Permite linhas de atÃ© 120 caracteres
          # --extend-ignore=E203,W503: Ignora conflitos com o Black
          # --exclude: Ignora diretÃ³rios de cache e migraÃ§Ãµes
          flake8 app/ \
            --max-line-length=120 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__,migrations,.venv \
            --statistics \
            --count

      - name: "ğŸ¨ Verificar formataÃ§Ã£o com black"
        run: |
          # --check: Apenas verifica, nÃ£o modifica os arquivos
          # --line-length=120: Consistente com o flake8
          # --diff: Mostra as diferenÃ§as encontradas
          black --check --line-length 120 --diff app/

  # â”€â”€ Job de Testes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: "ğŸ§ª Tests"
    runs-on: ubuntu-latest
    needs: lint  # SÃ³ executa testes se o lint passar

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: "ğŸ“¥ Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "ğŸ Configurar Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "backend/requirements.txt"

      - name: "ğŸ“¦ Instalar dependÃªncias"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ğŸ§ª Executar testes"
        run: |
          pytest tests/ -v --tb=short
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./test.db"
          GEMINI_API_KEY: ""
